<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>개인 리포트 확인</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 20px; }
    .box { max-width: 520px; margin: 0 auto; }
    input, button { font-size: 16px; padding: 10px 12px; }
    input { width: 100%; box-sizing: border-box; margin: 8px 0 12px; }
    button { width: 100%; cursor: pointer; }
    .msg { margin-top: 12px; color: #b00020; }
    .hint { color:#555; font-size: 14px; line-height: 1.4; }
    .ok { color:#0b6b0b; }
  </style>
</head>
<body>
  <div class="box">
    <h2>개인 리포트 확인</h2>
    <div class="hint">
      비밀번호(개인코드)를 입력하세요.<br/>
      예) <b>홍길동1234</b> (이름 공백 없이 + 휴대폰 뒷4자리)
    </div>

    <label for="code"><b>비밀번호</b></label>
    <!-- ✅ type="text": 입력값이 그대로 보이게 -->
    <input id="code" type="text" inputmode="text" autocomplete="off"
           placeholder="예: 홍길동1234" />

    <button id="btn" type="button">확인</button>

    <div id="msg" class="msg"></div>

    <hr/>
    <div class="hint">
      ※ 안내: 이 페이지는 GitHub Pages(정적 사이트)로 동작합니다.<br/>
      최종 Google Drive 파일의 공유 설정이 제한되어 있으면, 연결 후 “액세스 권한 필요”가 뜰 수 있습니다.
    </div>
  </div>

<script>
let MAP = null;
let composing = false;

async function loadMap() {
  if (MAP) return MAP;
  const res = await fetch("./mapping.json", { cache: "no-store" });
  if (!res.ok) throw new Error("mapping.json을 불러오지 못했습니다.");
  MAP = await res.json();
  return MAP;
}

// SHA-256 (브라우저 내장 WebCrypto)
async function sha256Hex(str) {
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, "0")).join("");
}

async function go() {
  // 한글 조합(IME) 중에는 실행하지 않음
  if (composing) return;

  const msg = document.getElementById("msg");
  msg.classList.remove("ok");
  msg.textContent = "";

  const raw = document.getElementById("code").value;
  const code = (raw || "").trim().replace(/\s+/g, "");

  if (!code) {
    msg.textContent = "비밀번호를 입력하세요.";
    return;
  }

  let map;
  try {
    map = await loadMap();
  } catch (e) {
    msg.textContent = "설정 오류: mapping.json 로드 실패";
    return;
  }

  const h = await sha256Hex(code);
  const target = map[h];

  if (!target) {
    msg.textContent = "비밀번호가 올바르지 않습니다. (예: 홍길동1234)";
    return;
  }

  msg.textContent = "이동 중입니다…";
  msg.classList.add("ok");
  window.location.href = target;
}

const input = document.getElementById("code");
const btn = document.getElementById("btn");

btn.addEventListener("click", go);

// IME(한글) 조합 이벤트 처리
input.addEventListener("compositionstart", () => composing = true);
input.addEventListener("compositionend", () => composing = false);

// Enter 처리
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    if (!composing) go();
  }
});
</script>
</body>
</html>
